---
title: Next.js Integration
description: How to integrate Varlock with Next.js for secure, type-safe environment management
---
import SyncedCodeTabs from '@/components/SyncedCodeTabs.astro'
import outdent from 'outdent';

Varlock provides a drop-in replacement for Next.js's internal env loader (`@next/env`) and adds powerful features for security, type-safety, and multi-environment management.

## Installation

First, install the integration and core packages:

```bash
npm install @varlock/nextjs-integration varlock
```

### 1. Override `@next/env` with Varlock

You must tell your package manager to override all resolutions of `@next/env` with `@varlock/nextjs-integration`.

<SyncedCodeTabs
  group="nextjs-pkg-manager"
  tabs={[
    {
      label: "npm",
      code: outdent`
        // package.json
        "dependencies": {
          "@varlock/nextjs-integration": "^1.2.3"
        },
        "overrides": {
          "@next/env": "$@varlock/nextjs-integration"
        }`
    ,
      lang: "json"
    },
    {
      label: "yarn",
      code: outdent`
        // package.json
        "resolutions": {
          "**/@next/env": "npm:@varlock/nextjs-integration@^1.2.3"
        }`,
      lang: "json"
    },
    {
      label: "pnpm",
      code: outdent`
        # pnpm-workspace.yaml
        overrides:
          "@next/env": "npm:@varlock/nextjs-integration@^1.2.3"`,
      lang: "yaml"
    }
  ]}
/>

:::caution
If you are in a monorepo, apply the override in the monorepo root (for npm/yarn) or always in `pnpm-workspace.yaml` (for pnpm).
:::

---

### 2. Enable the Next.js Config Plugin

To get the full benefits, add the Varlock config plugin to your `next.config.ts` (or `next.config.js`):

```ts title="next.config.ts"
import type { NextConfig } from "next";
import { varlockNextConfigPlugin } from '@varlock/nextjs-integration/plugin';

const nextConfig: NextConfig = {
  // your existing config...
};

export default varlockNextConfigPlugin()(nextConfig);
```

---

## Accessing Environment Variables

You can continue to use `process.env.SOMEVAR` as usual, but we recommend using Varlock's imported `ENV` object for better type-safety and DX:

```ts title="example.ts"
import { ENV } from 'varlock/env';

console.log(process.env.SOMEVAR); // ðŸ†— still works
console.log(ENV.SOMEVAR);         // âœ¨ recommended
```

### Type-safety and IntelliSense

To enable type-safety and IntelliSense for your env vars, enable the [`@generateTypes` root decorator](/reference/root-decorators/#generatetypes) in your `.env.schema`:

```env-spec title=".env.schema"
# @generateTypes(lang='ts', path='env.d.ts')
# ---
# your config items...
```

This generates types for both `process.env` and `ENV`.

#### Why use `ENV` instead of `process.env`?
- Non-string values (e.g., number, boolean) are properly typed and coerced
- All non-sensitive items are replaced at build time (not just `NEXT_PUBLIC_`)
- Better error messages for invalid or unavailable keys
- Enables future DX improvements and tighter control over what is bundled

---

## Managing Multiple Environments

Varlock can load multiple _environment-specific_ `.env` files (e.g., `.env.development`, `.env.preview`, `.env.production`).

By default, the environment flag is determined as follows (matching Next.js):
- `test` if `NODE_ENV` is `test`
- `development` if running `next dev`
- `production` otherwise

:::tip
Without a custom env flag, you cannot use non-production env files (like `.env.preview`, `.env.staging`) for non-prod deployments.
:::

We recommend explicitly setting your own environment flag using the [`@envFlag` root decorator](/reference/root-decorators/#envflag), e.g. `APP_ENV`.

### Setting the Environment Flag

#### Local/Custom Scripts

```json title="package.json"
"scripts": {
  "build:preview": "APP_ENV=preview next build",
  "start:preview": "APP_ENV=preview next start",
  "build:prod": "APP_ENV=production next build",
  "start:prod": "APP_ENV=production next start",
  "test": "APP_ENV=test jest"
}
```

#### Vercel

You can use the injected `VERCEL_ENV` variable:

```env-spec title=".env.schema"
# @envFlag=APP_ENV
# ---
# @type=enum(development, preview, production)
VERCEL_ENV=
APP_ENV=fallback($VERCEL_ENV, development)
```

For more granular environments, use `VERCEL_GIT_COMMIT_REF` (see Cloudflare example below).

#### Cloudflare Workers Build

Use the branch name to determine the environment:

```env-spec title=".env.schema"
# @envFlag=APP_ENV
# ---
WORKERS_CI_BRANCH=
# @type=enum(development, preview, production, test)
APP_ENV=remap($WORKERS_CI_BRANCH, production="main", preview=regex(.*), development=undefined)
```

---

## Managing Sensitive Config Values

Next.js uses the `NEXT_PUBLIC_` prefix to determine which env vars are public (bundled for the browser). Varlock lets you control this with the [`@defaultSensitive`](/reference/root-decorators/#defaultsensitive) root decorator.

To keep the prefix behavior:

```env-spec title=".env.schema"
# @defaultSensitive=inferFromPrefix('NEXT_PUBLIC_')
# ---
FOO= # sensitive
NEXT_PUBLIC_FOO= # non-sensitive, due to prefix
```

Or, set a default and explicitly mark items:

```env-spec title=".env.schema"
# @defaultSensitive=true
# ---
SECRET_FOO= # sensitive by default
# @sensitive=false
NON_SECRET_FOO=
```

:::caution[Bundling behavior]
All non-sensitive items are bundled at build time via `ENV`, while `process.env` replacements only include `NEXT_PUBLIC_`-prefixed items.
:::

---

## Reference
- [Root decorators reference](/reference/root-decorators)
- [Item decorators reference](/reference/item-decorators)
- [Functions reference](/reference/functions)
- [Next.js environment variable docs](https://nextjs.org/docs/pages/guides/environment-variables) 