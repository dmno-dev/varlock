---
title: Google Secret Manager Plugin
description: Using Google Cloud Secret Manager with Varlock
---

import { Steps, Icon } from '@astrojs/starlight/components';
import Badge from '@/components/Badge.astro';

<div class="page-badges">
  <Badge npmPackage="@varlock/google-secret-manager-plugin" />
</div>

Our [Google Cloud Secret Manager](https://cloud.google.com/secret-manager) plugin enables secure loading of secrets from GCP Secret Manager using declarative instructions within your `.env` files.

It supports authentication via [Application Default Credentials (ADC)](https://cloud.google.com/docs/authentication/application-default-credentials) or explicitly passing in a service account JSON key.

## Installation and setup

In a JS/TS project, you may install the `@varlock/google-secret-manager-plugin` package as a normal dependency.
Otherwise you can just load it directly from your `.env.schema` file, as long as you add a version specifier.
See the [plugins guide](/guides/plugins/#installation) for more instructions on installing plugins.

```env-spec title=".env.schema"
# 1. Load the plugin
# @plugin(@varlock/google-secret-manager-plugin)
#
# 2. Initialize the plugin - see below for more details on options
# @initGsm(projectId=my-gcp-project)
# ---
```

:::tip[Project ID]
The `projectId` parameter is optional if your service account JSON includes a `project_id` field, or if you have set `GOOGLE_CLOUD_PROJECT` in your environment. However, it's recommended to set it explicitly for clarity. If you don't provide `projectId` and are using ADC, the plugin will attempt to detect it from your `gcloud` configuration or environment variables.
:::


### Using Application Default Credentials (ADC) - recommended

By default (when no `credentials` parameter is set), this plugin will use [Application Default Credentials (ADC)](https://cloud.google.com/docs/authentication/application-default-credentials) to authenticate with Google Cloud. This is the recommended way to authenticate for local dev, and within GCP.

Within GCP, you will need to set up a [service account](https://cloud.google.com/iam/docs/service-accounts) with the correct permissions, and attach it to the resources where your code will be running.

Outside of GCP, you may set up ADC credentials using the [`gcloud auth application-default login`](https://docs.cloud.google.com/sdk/gcloud/reference/auth/application-default/login) command, which will store credentials locally, and make them available for ADC.


### Using a service account key

In rare cases, it may be useful to pass in a service account key explicitly. This is useful for deployed environments other than GCP, or if you need to use a different service account than the one attached to your service.

<Steps>

1. **Create and download a JSON key** for your service account. This can be done via the [Cloud Console](https://console.cloud.google.com/iam-admin/serviceaccounts) or using the `gcloud` CLI. [docs](https://cloud.google.com/iam/docs/keys-create-delete)

    ```bash
    gcloud iam service-accounts keys create key.json \
      --iam-account=SERVICE_ACCOUNT_EMAIL
    ```

2. **Wire up the service account key in your config**. Add a config item of type `gcpServiceAccountJson` to hold the key value, and reference it when initializing the plugin.

    ```diff lang="env-spec" title=".env.schema" add="credentials=$GCP_SA_KEY"
    # @plugin(@varlock/google-secret-manager-plugin)
    # @initGsm(projectId=my-gcp-project, credentials=$GCP_SA_KEY)
    # ---
    +# @type=gcpServiceAccountJson @sensitive
    +GCP_SA_KEY=
    ```

3. **Set your service account key in deployed environments**. Copy the JSON key content from the file you downloaded, and set it in deployed environments using your platform's env var management UI. Be sure to use the same name as you defined in your schema (e.g. `GCP_SA_KEY`).

</Steps>


:::caution[Keep service account keys secure]
Service account JSON keys are highly sensitive credentials. Store them securely and never commit them to version control. Consider using your platform's secret management system to store the key itself.
:::



### GCP Prerequisites

If you are already using GCP Secret Manager, you likely have completed these steps already, but if not, you will need to do so before using this plugin:

<Steps>
1. **Enable the Secret Manager API** (if not already done)

    Go to the Google Cloud Console and enable the Secret Manager API for your project.

2. **Create a new service account** in your GCP project. This can be done via the [Google Cloud Console](https://console.cloud.google.com/iam-admin/serviceaccounts) or using the `gcloud` CLI. [docs](https://cloud.google.com/iam/docs/service-accounts-create)

     This service account, whether accessed using ADC or a service account key, will now serve as your _secret-zero_ - which grants access to the rest of your sensitive data stored in Secret Manager.

3. **Grant the service account permissions** to access secrets. The service account needs the `Secret Manager Secret Accessor` role (`roles/secretmanager.secretAccessor`) on the secrets or project level. [docs](https://cloud.google.com/secret-manager/docs/access-control)

    ```bash
    gcloud projects add-iam-policy-binding PROJECT_ID \
      --member="serviceAccount:SERVICE_ACCOUNT_EMAIL" \
      --role="roles/secretmanager.secretAccessor"
    ```

4. **Attach the service account to GCP resources**
    
    You must [attach this service account](https://docs.cloud.google.com/iam/docs/attach-service-accounts#attaching-to-resources) to any resources where your code will be running.

</Steps>


## Pulling data from Secret Manager

Once the plugin is installed and initialized, you can start adding config items that load values from Google Secret Manager using the new `gsm()` resolver function.

### Secret reference formats

You can reference secrets using either a short format or a full resource path:

**Short format** (requires `projectId` to be set):
```env-spec
# Latest version
API_KEY=gsm("api-key")

# Specific version
DB_PASSWORD=gsm("database-password@5")
```

**Full resource path**:
```env-spec
# Full path format (projectId not required)
API_KEY=gsm("projects/my-project/secrets/api-key/versions/latest")
DB_PASSWORD=gsm("projects/my-project/secrets/database-password/versions/5")
```

:::tip[Secret versions]
If you don't specify a version in the short format, `latest` will be used automatically. For the full path format, you must include the version (use `latest` if you want the most recent version).
:::

### Multiple plugin instances

If you have multiple plugin instances (e.g., for different projects or environments), the `gsm()` function accepts an optional first parameter to specify which instance id to use.

```env-spec
# @initGsm(id=dev, projectId=my-dev-project)
# @initGsm(id=prod, projectId=my-prod-project, credentials=$GCP_SA_KEY_PROD)
# ---
# @type=gcpServiceAccountJson @sensitive
GCP_SA_KEY_PROD=
DEV_SECRET=gsm(dev, "dev-secret")
PROD_SECRET=gsm(prod, "prod-secret")
```

----


## Reference

### Root decorators
<div class="reference-docs">
<div>
#### `@initGsm()`

Initializes an instance of the Google Secret Manager plugin - setting up options and authentication. Can be called multiple times to set up different instances.

**Key/value args:**
- `id` (optional): identifier for this instance, used when multiple instances are needed
- `projectId` (optional): GCP project ID. Required for short secret reference format, or if credentials don't include a `project_id` field
- `credentials` (optional): service account JSON key. Should be a reference to a config item of type `gcpServiceAccountJson`. If omitted, Application Default Credentials will be used

```env-spec "@initGsm"
# @initGsm(id=prod, projectId=my-gcp-project, credentials=$GCP_SA_KEY)
# ---
# @type=gcpServiceAccountJson @sensitive
GCP_SA_KEY=
```
</div>
</div>


### Data types
<div class="reference-docs">
<div>
#### `gcpServiceAccountJson`

Represents a [Google Cloud service account JSON key](https://cloud.google.com/iam/docs/service-accounts). Validation ensures the JSON is valid and contains required fields (`type`, `project_id`, `private_key`, `client_email`). The type itself is marked as `@sensitive`, so adding an explicit `@sensitive` decorator is optional.

```env-spec "gcpServiceAccountJson"
# @type=gcpServiceAccountJson
GCP_SA_KEY=
```
</div>
</div>


### Resolver functions
<div class="reference-docs">
<div>
#### `gsm()`

Fetches a secret value from Google Secret Manager

**Array args:**
- `instanceId` (optional): instance identifier to use when multiple plugin instances are initialized
- `secretReference`: secret reference, either in short format (`"secret-name"` or `"secret-name@version"`) or full path format (`"projects/PROJECT_ID/secrets/SECRET_NAME/versions/VERSION"`)


```env-spec /gsm\\(.*\\)/
# Short format (requires projectId in @initGsm)
API_KEY=gsm("api-key")
DB_PASSWORD=gsm("database-password@5")

# Full path format
API_KEY=gsm("projects/my-project/secrets/api-key/versions/latest")

# Example using a plugin instance id
PROD_SECRET=gsm(prod, "prod-secret")
```
</div>
</div>



